server {
  index index.php index.html;
  server_name php-docker.local;
  error_log  /var/log/nginx/error.log;
  access_log /var/log/nginx/access.log;
  root /huabaobao/backend/public;

  location ~ \.php$ {
    try_files $uri = 404;
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    fastcgi_pass php:9000;
    fastcgi_index index.php;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
  }
  location / {
    if (!-e $request_filename) {
      rewrite ^/(.*)$ /index.php?s=/$1 last;
    }
  }
}
#api接口地址，加上后台管理
server
  {
    listen      80;
    listen      443 ssl http2;
    server_name  api.test.huabbao.com;
    ssl_certificate /etc/nginx/ssl/api.test.huabbao.com.pem;
    ssl_certificate_key /etc/nginx/ssl/api.test.huabbao.com.key;
    ssl_session_timeout 5m;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
    ssl_prefer_server_ciphers on;

    gzip on;
    #不压缩临界值，大于1K的才压缩，一般不用改
    gzip_min_length 1k;
    #buffer，就是，嗯，算了不解释了，不用改
    gzip_buffers 4 16k;
    #用了反向代理的话，末端通信是HTTP/1.0,默认是HTTP/1.1
    #gzip_http_version 1.0;
    #压缩级别，1-10，数字越大压缩的越好，时间也越长，看心情随便改吧
    gzip_comp_level 2;
    #进行压缩的文件类型，缺啥补啥就行了，JavaScript有两种写法，最好都写上吧，总有人抱怨js文件没有压缩，其实多写一种格式application/javascript 就行了
    gzip_types application/json;
    #跟Squid等缓存服务有关，on的话会在Header里增加"Vary: Accept-Encoding"
    gzip_vary on;
    #IE6对Gzip不怎么友好，不给它Gzip了
    gzip_disable "MSIE [1-6]\.";




    index index.html  index.htm index.php;
    root /huabaobao/backend/public;
    location / {
      if (!-e $request_filename) {
        rewrite ^/(.*)$ /index.php?s=/$1 last;
      }
    }
    location ~ \.php$ {
      try_files $uri = 404;
      fastcgi_split_path_info ^(.+\.php)(/.+)$;
      fastcgi_pass php:9000;
      fastcgi_index index.php;
      include fastcgi_params;
      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
      fastcgi_param PATH_INFO $fastcgi_path_info;
    }
    location ^~ /api/go {
      proxy_pass http://go:8080/api;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host api.test.huabbao.com;
    }
    location ^~ /api/micro/interact/ {
      proxy_pass http://api-interact:8888/;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host api.test.huabbao.com;
    }
    location ^~ /api/micro/free/ {
      proxy_pass http://api-free:8888/;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host api.test.huabbao.com;
    }
    location ^~ /api/micro/message/ {
      proxy_pass http://api-message:8888/;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host api.test.huabbao.com;
    }
    location ^~ /api/micro/community/ {
    proxy_pass http://api-community:8888/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host api.test.huabbao.com;
    }
    location ^~ /api/micro/user/ {
      proxy_pass http://api-user:8888/;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host api.test.huabbao.com;
    }
    location ^~ /api/micro/order/ {
      proxy_pass http://api-order:8888/;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host api.test.huabbao.com;
    }
    location ^~ /api/micro/tag/ {
      proxy_pass http://api-tag:8888/;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host api.test.huabbao.com;
    }
    location ^~ /api/micro/festival/ {
      proxy_pass http://api-festival:8888/;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host api.test.huabbao.com;
    }
    location ^~ /api/micro/search/ {
      proxy_pass http://api-search:8888/;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host api.test.huabbao.com;
    }
    location ^~ /api/micro/system/ {
      proxy_pass http://api-system:8888/;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host api.test.huabbao.com;
    }
  }

#web
server
  {
    listen      80;
    server_name  pc.test.huabbao.com;
    index index.html  index.htm index.php;
    root /huabaobao/backend/public;
    location / {
      if (!-e $request_filename) {
        rewrite ^/(.*)$ /index.php?s=/$1 last;
      }
    }
    location ~ \.php$ {
      try_files $uri = 404;
      fastcgi_split_path_info ^(.+\.php)(/.+)$;
      fastcgi_pass php:9000;
      fastcgi_index index.php;
      include fastcgi_params;
      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
      fastcgi_param PATH_INFO $fastcgi_path_info;
    }
  }

#静态资源
server
  {
    listen      80;
    server_name  src.test.huabbao.com;
    index index.html  index.htm  ;
    root /huabaobao/backend/src;

    location / {
      add_header 'Access-Control-Allow-Origin' '*';
      add_header 'Access-Control-Allow-Headers' 'X-Requested-With';
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
      if ($request_method = 'OPTIONS'){
        add_header 'Access-Control-Max-Age' 2592000;
        add_header 'Content-Type' 'text/plain; charset = utf-8';
        add_header 'Content-Length' 0;
        return 204;
      }
    }
    location ~ .*\.(js|jpg|JPG|jpeg|JPEG|css|bmp|gif|GIF|mp3|ico|wav|WAV|swf|SWF|png)$
      {
        expires      7d;
        access_log off;
      }
  }

upstream hbbserver{
  server node:3000;
  keepalive 64;
}

server {
  listen         80;
  listen         443 ssl http2;
  server_name    m.test.huabbao.com;
  ssl_certificate /etc/nginx/ssl/m.test.huabbao.com.pem;
  ssl_certificate_key /etc/nginx/ssl/m.test.huabbao.com.key;
  ssl_session_timeout 5m;
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
  ssl_prefer_server_ciphers on;

  gzip on;
  #不压缩临界值，大于1K的才压缩，一般不用改
  gzip_min_length 1k;
  #buffer，就是，嗯，算了不解释了，不用改
  gzip_buffers 4 16k;
  #用了反向代理的话，末端通信是HTTP/1.0,默认是HTTP/1.1
  #gzip_http_version 1.0;
  #压缩级别，1-10，数字越大压缩的越好，时间也越长，看心情随便改吧
  gzip_comp_level 2;
  #进行压缩的文件类型，缺啥补啥就行了，JavaScript有两种写法，最好都写上吧，总有人抱怨js文件没有压缩，其实多写一种格式application/javascript 就行了
  gzip_types application/json;
  #跟Squid等缓存服务有关，on的话会在Header里增加"Vary: Accept-Encoding"
  gzip_vary off;
  #IE6对Gzip不怎么友好，不给它Gzip了
  gzip_disable "MSIE [1-6]\.";

  location / {
    index index.html index.php index.htm
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Real-Port $remote_port;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass		http://hbbserver;
  }
  location /iPhaBCaz2b.txt {
       proxy_pass https://img.cdn.huabbao.com/txt/iPhaBCaz2b.txt;
  }

  location ^~ /api {
    proxy_set_header Host api.test.huabbao.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Real-Port $remote_port;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://api.test.huabbao.com/api;
  }
  location ^~ /api/go {
    proxy_pass http://go:8080/api;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host api.test.huabbao.com;
  }
  location /account/points {
    rewrite ^/account/points(.*)$ /points/$1 last;
  }
  location ^~ /api/micro/interact/ {
    proxy_pass http://api-interact:8888/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host api.test.huabbao.com;
  }
  location ^~ /api/micro/free/ {
    proxy_pass http://api-free:8888/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host api.test.huabbao.com;
  }
  location ^~ /api/micro/tag/ {
    proxy_pass http://api-tag:8888/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host api.test.huabbao.com;
  }
  location ^~ /api/micro/community/ {
    proxy_pass http://api-community:8888/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host api.test.huabbao.com;
  }
  location ^~ /api/micro/user/ {
    proxy_pass http://api-user:8888/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host api.test.huabbao.com;
  }
  location ^~ /api/micro/order/ {
    proxy_pass http://api-order:8888/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host api.test.huabbao.com;
  }
  location ^~ /api/micro/message/ {
    proxy_pass http://api-message:8888/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host api.test.huabbao.com;
  }
  location ^~ /api/micro/festival/ {
    proxy_pass http://api-festival:8888/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host api.test.huabbao.com;
  }
  location ^~ /api/micro/search/ {
    proxy_pass http://api-search:8888/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host api.test.huabbao.com;
  }
  location ^~ /api/micro/system/ {
    proxy_pass http://api-system:8888/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host api.test.huabbao.com;
  }
  access_log  /var/log/nginx/access_nuxt.log;
}


#管理后台
server
  {
    listen      80;
    server_name  admin.test.huabbao.com;
    index index.html  index.htm index.php;
    root /huabaobao/admin/public;
    client_max_body_size 80M;
    
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    location ~ \.php$ {
      fastcgi_pass admin_php:9000;
      fastcgi_index index.php;
      fastcgi_buffer_size 128k;
      fastcgi_buffers 4 256k;
      fastcgi_busy_buffers_size 256k;
      include fastcgi_params;
      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
      fastcgi_param PATH_INFO $fastcgi_path_info;
    }
  }
